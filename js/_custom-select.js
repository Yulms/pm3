import appendCustomFocusEvents from"./custom-focus-events.js";import{generateId}from"./util.js";class CustomSelect{constructor(t,e){Object.assign(this,{mainSelector:".custom-select",inputSelector:"input",listSelector:".custom-select__list",listCloseClass:"custom-select__list--closed",itemSelector:".custom-select__item",statusSelector:'[aria-live="polite"]',itemTitleSelector:".custom-select__item-title",filteredStatusPrefix:"Доступно вариантов : "},e),this.element=t,this.inputElement=this.element.querySelector(this.inputSelector),this.state={isOpened:!1},this.listElement=this.element.querySelector(this.listSelector),this.itemElements=this.element.querySelectorAll(this.itemSelector),this.items=Array.from(this.itemElements),this.statusElement=this.element.querySelector(this.statusSelector);let s=generateId();this.listElement.id=s,this.element.setAttribute("role","combobox"),this.element.setAttribute("aria-haspopup","listbox"),this.element.setAttribute("aria-owns",this.listElement.id),this.element.setAttribute("aria-expanded","false"),this.inputElement.setAttribute("aria-controls",this.listElement.id),this.inputElement.setAttribute("aria-autocomplete","both"),this.listElement.setAttribute("role","listbox"),this.itemElements.forEach((function(t){t.setAttribute("role","option"),t.setAttribute("tabindex","-1")})),this.inputElement.addEventListener("click",()=>{this._toggleList()}),this.listElement.addEventListener("click",()=>{const t=document.activeElement;"LI"===t.tagName&&(this._makeChoice(t),this._toggleList())}),this.element.addEventListener("keyup",t=>{this._doKeyAction(t.key)}),appendCustomFocusEvents(this.element),this.element.addEventListener("focusLeave",()=>{this.state.isOpened&&this._toggleList("shut")}),document.addEventListener("click",t=>{!t.target.closest(this.mainSelector)&&this.state.isOpened&&this._toggleList("shut")})}_toggleList(t="toggle"){let e=()=>{this.listElement.classList.remove(this.listCloseClass),this.element.setAttribute("aria-expanded","true"),this.state.isOpened=!0},s=()=>{this.listElement.classList.add(this.listCloseClass),this.element.setAttribute("aria-expanded","false"),this.state.isOpened=!1};switch(t){case"toggle":this.state.isOpened?s():e();break;case"open":e();break;case"shut":s()}}_makeChoice(t){const e=t.querySelector(this.itemTitleSelector);this.inputElement.value=e.textContent,this.inputElement.focus()}_moveFocus({moveDirection:t}){const e=this.items.filter(t=>""===t.style.display),s=document.activeElement;let i,l=()=>{switch(!0){case s===this.inputElement:e[e.length-1].focus();break;case"LI"===s.tagName:i=e.indexOf(s),0===i?this.inputElement.focus():e[i-1].focus()}},n=()=>{switch(!0){case s===this.inputElement:e[0].focus();break;case"LI"===s.tagName:i=e.indexOf(s),i!==e.length-1?e[i+1].focus():e[0].focus()}};0!==e.length&&("up"===t?l():n())}_doKeyAction(t){const e=document.activeElement;switch(t){case"Enter":this.state.isOpened&&"LI"===e.tagName&&this._makeChoice(e),this._toggleList();break;case"Escape":this.state.isOpened&&this._toggleList();break;case"ArrowDown":this.state.isOpened||this._toggleList(),this._moveFocus({moveDirection:"down"});break;case"ArrowUp":this.state.isOpened||this._toggleList(),this._moveFocus({moveDirection:"up"});break;default:this.state.isOpened||this._toggleList(),this._doFilter()}}_doFilter(){const t=this.inputElement.value;this.itemElements.forEach(t=>t.style.display="none");const e=this.items.filter(e=>e.innerText.toUpperCase().startsWith(t.toUpperCase()));e.forEach(t=>t.style.display=""),this._updateStatus(e.length)}_updateStatus(t){this.statusElement.textContent=this.filteredStatusPrefix+t}}const mainSelector=".custom-select";function initCustomSelects(){const t=document.querySelectorAll(mainSelector);return[].map.call(t,t=>new CustomSelect(t))}export default initCustomSelects;